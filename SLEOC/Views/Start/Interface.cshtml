@model SLEOC.Models.InterfaceModel
@using SLEOC.Helpers

@{
    ViewBag.Title = "Interface";
}

<!--SignalR-->
<script src="@Url.Content("~/Scripts/jquery.signalR-2.1.2.js")"></script>
<script src="~/signalr/hubs"></script>
<script>
    // Reference the auto-generated proxy for the hub.
    var cardHubClient = jQuery.connection.cardHub;
    var key = '@(!Model.Key.IsEmpty() ? Model.Key : "public" )';
    var currentTeam = 4;
    var currentTeamName = "EOC Management";

    function goToCard(cardNumber) {
        var card = document.getElementById("card");
        var left = cardNumber * 640;
        left = 640 * Math.floor(left / 640);
        card.style.left = (left * -1) + "px";
        updateScrollButton();
    }

    function goToLatestCard() {
        var latestPage = jQuery("#card article").length - 1;
        goToCard(latestPage);
    }

    function updateTeamDisplay() {
        var teamDisplay = jQuery("#currentTeam");
        var teamColor = "yellow";

        switch(currentTeam) {
            case 1:
                teamColor = "red";
                break;
            case 2:
                teamColor = "blue";
                break;
            case 3:
                teamColor = "green";
                break;
            default:
                teamColor = "yellow";
                break;
        }

        jQuery(teamDisplay).html("Current Team: <span class='" + teamColor + "'>" + currentTeamName + "</span>");
    }

    function updateScrollButton() {
        var card = document.getElementById("card");
        var leftScroll = document.getElementById("previousCard");
        var rightScroll = document.getElementById("nextCard");
        var count = jQuery("#card article").length;
        var left = parseFloat(card.style.left);

        console.log("left: " + left);

        if (left == 0)
        {
            console.log("Hiding left button");
            leftScroll.style.display = "none";
        }
        else
        {
            console.log("Showing left button");
            leftScroll.style.display = "block";
        }

        if (left > (count - 1) * -640)
        {
            console.log("Showing right button");
            rightScroll.style.display = "block";
        }
        else
        {
            console.log("Hiding right button");
            rightScroll.style.display = "none";
        }
    }

    function nextCard()
    {
        var card = document.getElementById("card");
        var left = card.getBoundingClientRect().left - 640;
        left = 640 * Math.floor(left / 640);
        card.style.left = left + "px";
        updateScrollButton();
    }

    function previousCard()
    {
        var card = document.getElementById("card");
        var left = card.getBoundingClientRect().left + 640;
        left = 640 * Math.floor(left / 640);
        card.style.left = left + "px";
        updateScrollButton();
    }

    function initialize()
    {
        var card = document.getElementById("card");
        var leftScroll = document.getElementById("previousCard");
        var rightScroll = document.getElementById("nextCard");

        card.style.left = "0px";
        leftScroll.style.display = "none";
        rightScroll.style.display = "none";
        updateScrollButton();
        updateTeamDisplay()
    }

    jQuery(function () {
        initialize();

        document.getElementById("previousCard").onclick = function () {
            previousCard();
        };

        document.getElementById("nextCard").onclick = function () {
            nextCard();
        };

        cardHubClient.client.log = function (message) {
            console.log(message);
        }

        cardHubClient.client.goToCard = function (cardNumber) {
            goToCard(cardNumber);
        }

        cardHubClient.client.joinTeam = function (team) {
            updateTeamDisplay(team);
        }

        cardHubClient.client.receiveCard = function (data) {
            var cardArea = jQuery('#card');
            jQuery(cardArea).append(data);
        }

        cardHubClient.client.addCard = function (cardType, encryptedParameter) {
            var cardArea = jQuery('#card');
            var ajaxUrl = '@Url.Action("Index", "EncryptedCard")';
            console.log("Requesting card html from " + ajaxUrl);
            jQuery.ajax({
                type: 'GET',
                url: ajaxUrl,
                cache: false,
                data: {
                    type: cardType,
                    encrypted: encryptedParameter
                },
                success: function (response) {
                    jQuery(cardArea).append(response);
                    goToLatestCard();
                }
            });
        }

        cardHubClient.client.setCard = function (cardType, encryptedParameter) {
            var cardArea = jQuery('#card');
            var ajaxUrl = '@Url.Action("Index", "EncryptedCard")';
            console.log("Requesting card html from " + ajaxUrl);
            jQuery.ajax({
                type: 'GET',
                url: ajaxUrl,
                cache: false,
                data: {
                    type: cardType,
                    encrypted: encryptedParameter
                },
                success: function (response) {
                    jQuery(cardArea).html(response);
                    goToLatestCard();
                }
            });
        }

        console.log("Connecting to Hub...");
        jQuery.connection.hub.start({ transport: 'longPolling' }).done(function () {
            function joinTeam(team) {
                currentTeam = team;
                switch (team) {
                    case 1:
                        currentTeamName = "Planning";
                        break;
                    case 2:
                        currentTeamName = "Operations";
                        break;
                    case 3:
                        currentTeamName = "Logistics";
                        break;
                    default:
                        currentTeamName = "EOC Management";
                        break;
                }

                cardHubClient.server.joinTeam(team);
                updateTeamDisplay();
            }

            document.getElementById("joinTeamOne").onclick = function () {
                joinTeam(1);
            };

            document.getElementById("joinTeamTwo").onclick = function () {
                joinTeam(2);
            };

            document.getElementById("joinTeamThree").onclick = function () {
                joinTeam(3);
            };

            document.getElementById("joinTeamFour").onclick = function () {
                joinTeam(4);
            };

            cardHubClient.server.joinHub('@(!Model.Key.IsEmpty() ? Model.Key : "public" )');
            cardHubClient.server.joinTeam(currentTeam);
            console.log('Now connected, connection ID = ' + jQuery.connection.hub.id);
        });
    });
</script>

<div id="card" class="card">
    @Html.Action("Start", "Card")
    @Html.Action("Team", "Card")
</div>
<div id="previousCard" class="scroll leftscroll"></div>
<div id="nextCard" class="scroll rightscroll"></div>
